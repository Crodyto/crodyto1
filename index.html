<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Crodyto Home - Enhanced Profile</title>
<style>
  :root { --accent:#0066ff; --muted:#f6f8fa; --glow:rgba(0,102,255,.25); --bg:#fff; --fg:#111; --card:#fff; --border:#eee; --mutetext:#666; }
  [data-theme="dark"] { --bg:#0b0f14; --fg:#e6eef7; --card:#10161d; --border:#1f2a35; --mutetext:#a5b2c1; --glow:rgba(0,102,255,.35); --muted:#1a1f26; }
  body { margin:0; font-family:system-ui,Segoe UI,Arial; background:var(--bg); color:var(--fg); transition:overflow 0.3s ease; }

  .header { display:flex; gap:12px; align-items:center; padding:12px 16px; border-bottom:1px solid var(--border); position:sticky; top:0; background:var(--card); z-index:10; }
  .logo { font-weight:700; color:var(--accent); font-size:20px; }
  .search { flex:1; }
  .search input { width:100%; padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--fg); transition:border-color .3s, box-shadow .3s; }
  .search input:focus { border-color:var(--accent); box-shadow:0 0 0 3px var(--glow); outline:0; }

  nav { display:flex; gap:10px; align-items:center; }
  .btn { padding:8px 12px; border:1px solid var(--border); border-radius:999px; background:var(--card); color:var(--fg); cursor:pointer; transition:transform .2s, box-shadow .2s; }
  .btn:hover { transform:translateY(-1px); box-shadow:0 6px 16px rgba(0,0,0,.06); }
  .primary { background:var(--accent); color:#fff; border-color:var(--accent); }
  .primary:hover { transform:translateY(-1px) scale(1.02); box-shadow:0 8px 24px rgba(0,102,255,.25); }
  .btn.ghost { background:transparent; border:1px solid var(--border); }
  .btn.pill { border-radius:999px; }

  .hero { padding:32px 16px; background:linear-gradient(180deg,#eef4ff,transparent); border-bottom:1px solid var(--border); opacity:0; transform:translateY(8px); animation:fadeUp .6s ease .15s forwards; }
  @keyframes fadeUp { to { opacity:1; transform:translateY(0); } }

  section { border-color:var(--border); }
  .grid { display:grid; gap:12px; grid-template-columns:repeat(auto-fill,minmax(150px,1fr)); padding:16px; }

  .tile { border:1px solid var(--border); border-radius:12px; background:var(--card); overflow:hidden; transition:transform .2s, box-shadow .2s, border-color .2s; }
  .tile img { width:100%; height:120px; object-fit:cover; background:#1a1a1a10; transition:transform .25s; }
  .tile span { display:block; padding:8px 10px; font-weight:600; }
  .tile:hover { transform:translateY(-4px); box-shadow:0 12px 28px rgba(0,0,0,.08), 0 0 0 4px var(--glow); border-color:transparent; }
  .tile:hover img { transform:scale(1.03); }

  .card { border:1px solid var(--border); border-radius:12px; background:var(--card); overflow:hidden; transition:transform .2s, box-shadow .2s; }
  .card img { width:100%; height:140px; object-fit:cover; background:#1a1a1a10; transition:transform .3s; }
  .card .info { padding:10px; }
  .price { color:#0a7; font-weight:700; }
  .card:hover { transform:translateY(-5px); box-shadow:0 14px 32px rgba(0,0,0,.10); }
  .card:hover img { transform:scale(1.05); }

  .badge { position:relative; top:-6px; margin-left:6px; background:#ff3b30; color:#fff; border-radius:999px; padding:2px 8px; font-size:12px; display:inline-block; }
  .badge.pulse { animation:pulse .5s ease; }
  @keyframes pulse { 0%{ transform:scale(1); } 50%{ transform:scale(1.2); } 100%{ transform:scale(1); } }

  .contact { padding:16px; border-top:1px solid var(--border); }
  .contact form { display:grid; gap:10px; max-width:420px; }
  input, textarea { padding:10px 12px; border:1px solid var(--border); border-radius:8px; font:inherit; background:var(--card); color:var(--fg); }

  .btn .spinner { --sz:16px; width:var(--sz); height:var(--sz); border-radius:50%; border:2px solid rgba(255,255,255,.6); border-top-color:#fff; margin-left:8px; display:none; animation:spin 1s linear infinite; }
  @keyframes spin { to { transform:rotate(360deg); } }
  .btn.loading span.txt { opacity:.6; }
  .btn.loading .spinner { display:inline-block; }

  footer { padding:20px 16px; text-align:center; color:var(--mutetext); border-top:1px solid var(--border); }

  /* Block body scroll when full-screen overlay is active */
  body.overlay-open { overflow:hidden !important; }

  /* Enhanced Profile Modal with Ambient Effects */
  .profile-modal-backdrop { 
    position:fixed; 
    inset:0; 
    background: radial-gradient(circle at 20% 50%, rgba(59, 130, 246, 0.15) 0%, transparent 50%),
                radial-gradient(circle at 80% 50%, rgba(139, 92, 246, 0.15) 0%, transparent 50%),
                rgba(0,0,0,.6); 
    display:none; 
    align-items:center; 
    justify-content:center; 
    z-index:1000; 
    backdrop-filter: blur(8px);
    animation: ambientGlow 8s ease-in-out infinite alternate;
  }
  
  @keyframes ambientGlow {
    0% { 
      background: radial-gradient(circle at 20% 30%, rgba(59, 130, 246, 0.2) 0%, transparent 60%),
                  radial-gradient(circle at 80% 70%, rgba(139, 92, 246, 0.15) 0%, transparent 60%),
                  rgba(0,0,0,.6); 
    }
    33% { 
      background: radial-gradient(circle at 60% 20%, rgba(236, 72, 153, 0.18) 0%, transparent 60%),
                  radial-gradient(circle at 40% 80%, rgba(34, 197, 94, 0.15) 0%, transparent 60%),
                  rgba(0,0,0,.6); 
    }
    66% { 
      background: radial-gradient(circle at 80% 40%, rgba(251, 191, 36, 0.2) 0%, transparent 60%),
                  radial-gradient(circle at 20% 60%, rgba(239, 68, 68, 0.15) 0%, transparent 60%),
                  rgba(0,0,0,.6); 
    }
    100% { 
      background: radial-gradient(circle at 40% 70%, rgba(139, 92, 246, 0.2) 0%, transparent 60%),
                  radial-gradient(circle at 70% 30%, rgba(59, 130, 246, 0.15) 0%, transparent 60%),
                  rgba(0,0,0,.6); 
    }
  }
  
  .profile-modal { 
    width:100%; 
    max-width:800px; 
    height:90vh;
    max-height:700px;
    background: rgba(255,255,255,0.95); 
    color:var(--fg); 
    border-radius:24px; 
    box-shadow: 0 32px 80px rgba(0,0,0,.25), 
                0 0 0 1px rgba(255,255,255,0.1); 
    overflow:hidden; 
    transform:translateY(30px) scale(0.9); 
    opacity:0; 
    animation:profileSlideIn .4s ease forwards; 
    backdrop-filter: blur(20px);
    border: 1px solid rgba(255,255,255,0.2);
  }
  
  [data-theme="dark"] .profile-modal {
    background: rgba(16,22,29,0.95);
    border: 1px solid rgba(255,255,255,0.1);
  }
  
  @keyframes profileSlideIn { 
    to { 
      opacity:1; 
      transform:translateY(0) scale(1); 
    } 
  }
  
  .profile-modal-header { 
    display:flex; 
    align-items:center; 
    justify-content:space-between; 
    padding:20px 24px; 
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.1), rgba(139, 92, 246, 0.1));
    border-bottom:1px solid rgba(255,255,255,0.1); 
    position: relative;
    overflow: hidden;
  }
  
  .profile-modal-header::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255,255,255,0.1), transparent);
    animation: shimmer 3s infinite;
  }
  
  @keyframes shimmer {
    0% { left: -100%; }
    100% { left: 100%; }
  }
  
  .profile-modal h3 { margin:0; font-size:24px; font-weight:700; }
  .profile-modal .close { 
    border:none; 
    background:rgba(255,255,255,0.1); 
    font-size:24px; 
    cursor:pointer; 
    line-height:1; 
    color:var(--fg); 
    width:44px;
    height:44px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    transition: all 0.3s ease;
  }
  .profile-modal .close:hover {
    background:rgba(255,255,255,0.2);
    transform: rotate(90deg);
  }

  /* Profile Content Area */
  .profile-content {
    padding: 0;
    height: calc(100% - 84px);
    display: flex;
    flex-direction: column;
  }

  /* Enhanced Profile Header */
  .profile-header {
    position: relative;
    height: 200px;
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    overflow: hidden;
    display: flex;
    align-items: flex-end;
    padding: 24px;
  }
  
  .ambient-orbs {
    position: absolute;
    inset: 0;
    overflow: hidden;
  }
  
  .orb {
    position: absolute;
    border-radius: 50%;
    opacity: 0.6;
    animation: float 6s ease-in-out infinite;
  }
  
  .orb:nth-child(1) {
    width: 80px;
    height: 80px;
    background: radial-gradient(circle, rgba(255,255,255,0.3), transparent);
    top: 20%;
    left: 10%;
    animation-delay: 0s;
  }
  
  .orb:nth-child(2) {
    width: 120px;
    height: 120px;
    background: radial-gradient(circle, rgba(255,255,255,0.2), transparent);
    top: 60%;
    right: 15%;
    animation-delay: 2s;
  }
  
  .orb:nth-child(3) {
    width: 60px;
    height: 60px;
    background: radial-gradient(circle, rgba(255,255,255,0.4), transparent);
    bottom: 20%;
    left: 60%;
    animation-delay: 4s;
  }
  
  @keyframes float {
    0%, 100% { transform: translateY(0px) rotate(0deg); }
    50% { transform: translateY(-20px) rotate(180deg); }
  }

  .profile-avatar-section {
    display: flex;
    align-items: center;
    gap: 16px;
    z-index: 2;
  }

  .profile-avatar {
    width: 80px;
    height: 80px;
    border-radius: 50%;
    border: 4px solid rgba(255,255,255,0.9);
    box-shadow: 0 8px 32px rgba(0,0,0,0.3);
    object-fit: cover;
  }

  .profile-info h2 {
    margin: 0;
    color: white;
    font-size: 28px;
    font-weight: 700;
    text-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }

  .profile-info p {
    margin: 4px 0 0;
    color: rgba(255,255,255,0.9);
    font-size: 16px;
  }

  /* Profile Navigation Tabs */
  .profile-nav {
    display: flex;
    background: rgba(255,255,255,0.05);
    border-bottom: 1px solid rgba(255,255,255,0.1);
  }

  .profile-nav button {
    flex: 1;
    padding: 16px 20px;
    border: none;
    background: transparent;
    color: var(--fg);
    font-size: 16px;
    font-weight: 500;
    cursor: pointer;
    transition: all 0.3s ease;
    position: relative;
  }

  .profile-nav button.active {
    background: linear-gradient(135deg, rgba(59, 130, 246, 0.2), rgba(139, 92, 246, 0.2));
    color: var(--accent);
  }

  .profile-nav button.active::after {
    content: '';
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    height: 3px;
    background: linear-gradient(90deg, var(--accent), #8b5cf6);
    border-radius: 3px 3px 0 0;
  }

  .profile-nav button:hover:not(.active) {
    background: rgba(255,255,255,0.1);
  }

  /* Profile Content Panels */
  .profile-panels {
    flex: 1;
    overflow-y: auto;
    padding: 24px;
  }

  .profile-panel {
    display: none;
    animation: fadeInUp 0.3s ease forwards;
  }

  .profile-panel.active {
    display: block;
  }

  @keyframes fadeInUp {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  /* Profile Settings Panel */
  .profile-form {
    display: grid;
    gap: 20px;
    max-width: 400px;
  }

  .form-group {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }

  .form-group label {
    font-weight: 600;
    color: var(--fg);
    font-size: 14px;
  }

  .form-group input {
    padding: 12px 16px;
    border: 2px solid var(--border);
    border-radius: 12px;
    background: var(--card);
    color: var(--fg);
    font-size: 16px;
    transition: all 0.3s ease;
  }

  .form-group input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--glow);
    transform: translateY(-1px);
  }

  /* Orders & Wishlist Styling */
  .items-grid {
    display: grid;
    gap: 16px;
    margin-top: 16px;
  }

  .item-card {
    background: rgba(255,255,255,0.5);
    border: 1px solid rgba(255,255,255,0.2);
    border-radius: 16px;
    padding: 16px;
    transition: all 0.3s ease;
    backdrop-filter: blur(10px);
  }

  [data-theme="dark"] .item-card {
    background: rgba(255,255,255,0.05);
    border: 1px solid rgba(255,255,255,0.1);
  }

  .item-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 32px rgba(0,0,0,0.1);
    background: rgba(255,255,255,0.7);
  }

  [data-theme="dark"] .item-card:hover {
    background: rgba(255,255,255,0.1);
  }

  /* Order notification */
  .order-notification {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    background: linear-gradient(135deg, #22c55e, #16a34a);
    color: white;
    padding: 30px 40px;
    border-radius: 20px;
    font-size: 24px;
    font-weight: 700;
    text-align: center;
    box-shadow: 0 20px 60px rgba(34, 197, 94, 0.4);
    z-index: 10000;
    display: none;
    animation: slideInScale 0.5s ease forwards;
    border: 3px solid rgba(255,255,255,0.2);
  }
  
  @keyframes slideInScale {
    0% {
      opacity: 0;
      transform: translate(-50%, -50%) scale(0.7) translateY(-20px);
    }
    100% {
      opacity: 1;
      transform: translate(-50%, -50%) scale(1) translateY(0);
    }
  }
  
  .order-notification.show {
    display: block;
  }
  
  .order-notification .check-icon {
    display: inline-block;
    margin-right: 10px;
    font-size: 28px;
    animation: bounceCheck 0.6s ease 0.2s forwards;
    opacity: 0;
  }
  
  @keyframes bounceCheck {
    0% { opacity: 0; transform: scale(0); }
    50% { opacity: 1; transform: scale(1.2); }
    100% { opacity: 1; transform: scale(1); }
  }
  
  .order-notification .order-id {
    display: block;
    font-size: 14px;
    font-weight: 400;
    margin-top: 8px;
    opacity: 0.9;
  }

  /* Account modal */
  .modal-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1000; }
  .modal { width:100%; max-width:560px; background:var(--card); color:var(--fg); border-radius:14px; box-shadow:0 24px 64px rgba(0,0,0,.25); overflow:hidden; transform:translateY(12px); opacity:0; animation:fadeUp .25s ease forwards; }
  .modal header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); }
  .modal h3 { margin:0; font-size:18px; }
  .modal .close { border:none; background:transparent; font-size:22px; cursor:pointer; line-height:1; color:var(--fg); }
  .tabs { display:flex; gap:6px; padding:8px; border-bottom:1px solid var(--border); flex-wrap:wrap; }
  .tabs button { flex:1; padding:8px; border-radius:999px; border:1px solid var(--border); background:var(--card); color:var(--fg); cursor:pointer; }
  .tabs button.active { background:var(--accent); color:#fff; border-color:var(--accent); }
  .panel { display:none; padding:14px; }
  .panel.active { display:block; }
  .row { display:grid; gap:8px; margin-bottom:12px; }
  .row input { padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--fg); }
  .muted { color:var(--mutetext); font-size:13px; }
  .alert { background:#fef3c7; border:1px solid #fde68a; color:#92400e; padding:8px 10px; border-radius:8px; margin:10px 14px; display:none; }
  .alert.show { display:block; }

  /* Cart drawer */
  .cart-toggle { position:relative; }
  .cart-drawer-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.4); display:none; z-index:1100; }
  .cart-drawer { position:fixed; top:0; right:0; height:100%; width:360px; max-width:92vw; background:var(--card); color:var(--fg); box-shadow:-16px 0 40px rgba(0,0,0,.18); transform:translateX(100%); transition:transform .3s ease; z-index:1200; display:flex; flex-direction:column; }
  .cart-header { display:flex; align-items:center; justify-content:space-between; padding:14px 16px; border-bottom:1px solid var(--border); }
  .cart-items { flex:1; overflow:auto; padding:12px 12px 0; }
  .cart-empty { padding:24px 16px; color:var(--mutetext); }
  .cart-item { display:grid; grid-template-columns:64px 1fr auto; gap:10px; padding:10px; border-bottom:1px solid var(--border); align-items:center; }
  .cart-item img { width:64px; height:64px; object-fit:cover; border-radius:8px; background:#1a1a1a10; }
  .cart-item h4 { margin:0 0 6px; font-size:14px; }
  .cart-item .meta { font-size:13px; color:var(--mutetext); }
  .qty { display:flex; align-items:center; gap:8px; }
  .qty button { width:28px; height:28px; border-radius:6px; border:1px solid var(--border); background:var(--card); color:var(--fg); cursor:pointer; }
  .remove { background:transparent; border:none; color:#c00; cursor:pointer; font-size:13px; }
  .cart-footer { border-top:1px solid var(--border); padding:12px 16px; }
  .cart-row { display:flex; align-items:center; justify-content:space-between; margin:8px 0; }
  .cart-actions { display:flex; gap:8px; margin-top:10px; }

  /* Admin modal */
  .admin-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1300; }
  .admin-modal { width:100%; max-width:520px; background:var(--card); color:var(--fg); border-radius:14px; box-shadow:0 24px 64px rgba(0,0,0,.25); overflow:hidden; transform:translateY(12px); opacity:0; animation:fadeUp .25s ease forwards; }
  .admin-modal header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); }
  .admin-body { display:grid; gap:16px; padding:14px; }
  .admin-card { border:1px solid var(--border); border-radius:12px; background:var(--card); padding:12px; }
  .admin-card h4 { margin:0 0 10px; }
  .admin-card .row { display:grid; gap:8px; }
  .admin-card input { padding:10px 12px; border:1px solid var(--border); border-radius:8px; background:var(--card); color:var(--fg); }
  .admin-gate { display:grid; gap:8px; }
  .admin-badge { display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); }

  /* Checkout modal */
  .checkout-backdrop { position:fixed; inset:0; background:rgba(0,0,0,.45); display:none; align-items:center; justify-content:center; z-index:1400; }
  .checkout-modal { width:100%; max-width:600px; background:var(--card); color:var(--fg); border-radius:14px; box-shadow:0 24px 64px rgba(0,0,0,.25); overflow:hidden; transform:translateY(12px); opacity:0; animation:fadeUp .25s ease forwards; }
  .checkout-modal header { display:flex; align-items:center; justify-content:space-between; padding:12px 14px; border-bottom:1px solid var(--border); }
  .checkout-body { display:grid; gap:14px; padding:14px; grid-template-columns:1fr; }
  @media (min-width: 720px) { .checkout-body { grid-template-columns:1fr 1fr; } }
  .ck-row { display:grid; gap:8px; }
  .ck-row input, .ck-row textarea, .ck-row select { padding:10px 12px; border:1px solid var(--border); border-radius:8px; font:inherit; background:var(--card); color:var(--fg); }
  .summary { border:1px solid var(--border); border-radius:12px; background:var(--card); padding:12px; }
  .summary h4 { margin:0 0 8px; }
  .summary .line { display:flex; justify-content:space-between; margin:4px 0; }
  .summary .items { max-height:180px; overflow:auto; border-top:1px dashed var(--border); margin-top:8px; padding-top:8px; font-size:14px; color:var(--mutetext); }
  #payMethods label { display:inline-flex; align-items:center; gap:6px; margin-right:12px; }
  .order-card { border:1px solid var(--border); border-radius:12px; background:var(--card); padding:12px; }
  .order-line { display:flex; justify-content:space-between; margin:4px 0; font-size:14px; }
  .order-items { margin-top:8px; font-size:13px; color:var(--mutetext); white-space:pre-line; display:none; }

  /* Respect reduced motion preference */
  @media (prefers-reduced-motion: reduce) {
    .order-notification { animation: none; opacity: 1; transform: translate(-50%, -50%) scale(1); }
    .check-icon { animation: none; opacity: 1; transform: scale(1); }
    .profile-modal-backdrop { animation: none; }
    .profile-modal { animation: none; opacity: 1; transform: none; }
    .orb { animation: none; }
    .profile-modal-header::before { animation: none; }
  }
</style>

<script type="module" defer>
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, sendPasswordResetEmail, updateProfile, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-auth.js";
  import { getFirestore, collection, getDocs, query, limit, addDoc, serverTimestamp, doc, setDoc, getDoc, deleteDoc, where, orderBy } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytesResumable, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.4/firebase-storage.js";

  // Firebase config
  const firebaseConfig = {
    apiKey: "AIzaSyC5MGkOf5_0cF-xQrcA1PBSSvq6Y-AarSc",
    authDomain: "ds-mart-888d2.firebaseapp.com",
    projectId: "ds-mart-888d2",
    storageBucket: "ds-mart-888d2.firebasestorage.app",
    messagingSenderId: "108308848034",
    appId: "1:108308848034:web:a8b3fe5e8784a4771e66fb",
    measurementId: "G-KY618BJER7",
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // UPI configuration
  const UPI_VPA = 'example@upi';
  const UPI_NAME = 'Crodyto';
  const UPI_NOTE_PREFIX = 'Crodyto Order';

  // Application state
  let allProducts = [];
  let cart = JSON.parse(localStorage.getItem('cart') || '[]');
  let wishlist = new Set();

  // Elements getter functions
  const els = {
    productGrid: () => document.getElementById('productGrid'),
    categoryGrid: () => document.getElementById('categoryGrid'),
    search: () => document.getElementById('search'),
    cartCount: () => document.getElementById('cartCount'),
    loginBtn: () => document.getElementById('loginBtn'),
    myProfileBtn: () => document.getElementById('myProfileBtn'),
    adminBtn: () => document.getElementById('adminBtn'),
    themeToggle: () => document.getElementById('themeToggle'),
    userPill: () => document.getElementById('userPill'),
    userAvatar: () => document.getElementById('userAvatar'),
    userName: () => document.getElementById('userName'),
    contactForm: () => document.getElementById('contactForm'),
    sendBtn: () => document.getElementById('sendBtn'),

    accountModal: () => document.getElementById('accountModal'),
    closeAccount: () => document.getElementById('closeAccount'),
    tabLogin: () => document.getElementById('tabLogin'),
    tabSignup: () => document.getElementById('tabSignup'),
    alertBox: () => document.getElementById('alertBox'),
    formLogin: () => document.getElementById('formLogin'),
    formSignup: () => document.getElementById('formSignup'),
    formProfile: () => document.getElementById('formProfile'),
    doReset: () => document.getElementById('doReset'),

    profileModal: () => document.getElementById('profileModal'),
    closeProfile: () => document.getElementById('closeProfile'),

    openCart: () => document.getElementById('openCart'),
    cartDrawer: () => document.getElementById('cartDrawer'),
    cartBackdrop: () => document.getElementById('cartBackdrop'),
    cartItems: () => document.getElementById('cartItems'),
    cartSubtotal: () => document.getElementById('cartSubtotal'),
    closeCart: () => document.getElementById('closeCart'),
    clearCart: () => document.getElementById('clearCart'),
    checkoutBtn: () => document.getElementById('checkoutBtn'),

    adminBackdrop: () => document.getElementById('adminBackdrop'),
    closeAdmin: () => document.getElementById('closeAdmin'),
    adminCode: () => document.getElementById('adminCode'),
    unlockAdmin: () => document.getElementById('unlockAdmin'),
    adminState: () => document.getElementById('adminState'),
    productCard: () => document.getElementById('productCard'),
    categoryCard: () => document.getElementById('categoryCard'),

    prodImageFile: () => document.getElementById('prodImageFile'),
    uploadProdImg: () => document.getElementById('uploadProdImg'),
    prodUploadProg: () => document.getElementById('prodUploadProg'),
    prodPreview: () => document.getElementById('prodPreview'),
    prodImageUrl: () => document.getElementById('prodImageUrl'),

    catImageFile: () => document.getElementById('catImageFile'),
    uploadCatImg: () => document.getElementById('uploadCatImg'),
    catUploadProg: () => document.getElementById('catUploadProg'),
    catPreview: () => document.getElementById('catPreview'),
    catImageUrl: () => document.getElementById('catImageUrl'),

    checkoutBackdrop: () => document.getElementById('checkoutBackdrop'),
    closeCheckout: () => document.getElementById('closeCheckout'),
    checkoutForm: () => document.getElementById('checkoutForm'),
    placeOrderBtn: () => document.getElementById('placeOrderBtn'),
    ckItemsCount: () => document.getElementById('ckItemsCount'),
    ckSubtotal: () => document.getElementById('ckSubtotal'),
    ckTotal: () => document.getElementById('ckTotal'),
    ckItemsList: () => document.getElementById('ckItemsList'),

    upiBox: () => document.getElementById('upiBox'),
    upiPayBtn: () => document.getElementById('upiPayBtn'),
    upiQR: () => document.getElementById('upiQR'),
    upiPayee: () => document.getElementById('upiPayee'),
    upiAmount: () => document.getElementById('upiAmount'),
    upiNote: () => document.getElementById('upiNote'),
  };

  // Theme management
  function applyTheme(t) { 
    document.documentElement.setAttribute('data-theme', t); 
    els.themeToggle().checked = (t === 'dark'); 
  }
  function initTheme() { 
    const t = localStorage.getItem('theme') || 'light'; 
    applyTheme(t); 
  }
  document.addEventListener('DOMContentLoaded', initTheme);
  els.themeToggle().addEventListener('change', () => {
    const t = els.themeToggle().checked ? 'dark' : 'light';
    localStorage.setItem('theme', t);
    applyTheme(t);
  });

  // Profile Modal Management
  function openProfileModal() {
    els.profileModal().style.display = 'flex';
    els.profileModal().setAttribute('aria-hidden', 'false');
    document.body.classList.add('overlay-open');
    setProfileTab('settings');
    loadProfileData();
  }

  function closeProfileModal() {
    els.profileModal().style.display = 'none';
    els.profileModal().setAttribute('aria-hidden', 'true');
    document.body.classList.remove('overlay-open');
  }

  function setProfileTab(tabName) {
    document.querySelectorAll('.profile-nav button').forEach(btn => btn.classList.remove('active'));
    document.querySelectorAll('.profile-panel').forEach(panel => panel.classList.remove('active'));
    
    document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');
    document.getElementById(`${tabName}Panel`).classList.add('active');
    
    if (tabName === 'orders') loadMyOrders();
    if (tabName === 'wishlist') loadMyWishlist();
  }

  function loadProfileData() {
    const user = auth.currentUser;
    if (!user) return;
    
    document.getElementById('profileDisplayName').textContent = user.displayName || user.email?.split('@')[0] || 'User';
    document.getElementById('profileEmail').textContent = user.email || 'No email';
    document.getElementById('profileAvatar').src = user.photoURL || `https://ui-avatars.com/api/?background=0D8ABC&color=fff&name=${encodeURIComponent(user.displayName || 'User')}`;
    
    document.getElementById('displayNameInput').value = user.displayName || '';
    document.getElementById('photoURLInput').value = user.photoURL || '';
  }

  // Simple Order Placed Notification Function
  function showOrderPlacedNotification(orderId) {
    const notification = document.createElement('div');
    notification.className = 'order-notification';
    notification.innerHTML = `
      <span class="check-icon">✅</span>
      Order Placed!
      <span class="order-id">Order ID: ${orderId}</span>
    `;
    
    document.body.appendChild(notification);
    
    setTimeout(() => {
      notification.classList.add('show');
    }, 100);
    
    setTimeout(() => {
      notification.classList.remove('show');
      setTimeout(() => {
        document.body.removeChild(notification);
      }, 500);
    }, 3000);
    
    if (window.confetti) {
      confetti({
        particleCount: 100,
        spread: 70,
        origin: { y: 0.6 }
      });
    }
  }

  // Cart management functions
  function updateCartBadge() {
    const n = cart.reduce((s, i) => s + i.qty, 0);
    const badge = els.cartCount();
    badge.textContent = n;
    badge.classList.remove('pulse'); 
    void badge.offsetWidth; 
    badge.classList.add('pulse');
  }

  function cartSave() { 
    localStorage.setItem('cart', JSON.stringify(cart)); 
    updateCartBadge(); 
    renderCart(); 
  }

  function addToCart(id) {
    const item = allProducts.find(p => p.id === id); 
    if (!item) return;
    const existing = cart.find(c => c.id === id);
    if (existing) {
      existing.qty += 1; 
    } else {
      cart.push({ 
        id: item.id, 
        title: item.title, 
        price: Number(item.price) || 0, 
        imageUrl: item.imageUrl, 
        qty: 1 
      });
    }
    cartSave();
  }

  function incQty(id) { 
    const it = cart.find(i => i.id === id); 
    if (!it) return; 
    it.qty += 1; 
    cartSave(); 
  }

  function decQty(id) { 
    const it = cart.find(i => i.id === id); 
    if (!it) return; 
    it.qty = Math.max(0, it.qty - 1); 
    if (it.qty === 0) cart = cart.filter(i => i.id !== id); 
    cartSave(); 
  }

  function removeItem(id) { 
    cart = cart.filter(i => i.id !== id); 
    cartSave(); 
  }

  function clearCart() { 
    cart = []; 
    cartSave(); 
  }

  function cartSubtotalValue() { 
    return cart.reduce((sum, i) => sum + (Number(i.price) || 0) * (i.qty || 0), 0); 
  }

  // Product rendering
  function cardTemplate(p, wished) {
    return `
      <div class="card">
        <img src="${p.imageUrl}" alt="${p.title}" />
        <div class="info">
          <h3 style="margin:0 0 6px;font-size:16px">${p.title}</h3>
          <div class="price">₹${p.price}</div>
          <div style="display:flex;gap:8px;align-items:center">
            <button data-id="${p.id}" class="btn add">Add to cart</button>
            <button data-id="${p.id}" class="wish btn" title="Wishlist" style="${wished?'color:#e11d48;border-color:#e11d48':''}">❤</button>
          </div>
        </div>
      </div>
    `;
  }

  function renderProducts(list) {
    els.productGrid().innerHTML = list.map(p => cardTemplate(p, wishlist.has(p.id))).join('');
    els.productGrid().querySelectorAll('button').forEach(btn => {
      if (btn.classList.contains('wish')) {
        btn.addEventListener('click', () => {
          const id = btn.dataset.id; 
          const pd = allProducts.find(x => x.id === id);
          if (pd) toggleWishlist(id, pd);
        });
      } else {
        btn.addEventListener('click', () => addToCart(btn.dataset.id));
      }
    });
  }

  function renderCategories(list) {
    els.categoryGrid().innerHTML = list.map(c => `
      <div class="tile" data-slug="${c.slug}">
        <img src="${c.imageUrl}" alt="${c.name}" />
        <span>${c.name}</span>
      </div>
    `).join('');
    els.categoryGrid().querySelectorAll('.tile').forEach(tile => {
      tile.addEventListener('click', () => {
        const slug = tile.dataset.slug;
        const filtered = allProducts.filter(p => (p.category || '').toLowerCase() === slug.toLowerCase());
        renderProducts(filtered);
      });
    });
  }

  // Data loading
  async function loadHome() {
    const catSnap = await getDocs(collection(db, 'categories'));
    renderCategories(catSnap.docs.map(d => ({ id: d.id, ...d.data() })));
    const qref = query(collection(db, 'products'), limit(20));
    const prodSnap = await getDocs(qref);
    allProducts = prodSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    renderProducts(allProducts);
  }

  // Search functionality
  document.addEventListener('DOMContentLoaded', () => {
    els.search().addEventListener('input', e => {
      const q = e.target.value.trim().toLowerCase();
      const filtered = allProducts.filter(p => 
        p.title.toLowerCase().includes(q) || 
        (p.category || '').toLowerCase().includes(q)
      );
      renderProducts(filtered);
    });
  });

  // Modal management
  function openAccount() { 
    els.accountModal().style.display = 'flex'; 
    els.accountModal().setAttribute('aria-hidden','false'); 
  }
  
  function closeAccount() { 
    els.accountModal().style.display = 'none'; 
    els.accountModal().setAttribute('aria-hidden','true'); 
  }

  els.loginBtn().addEventListener('click', openAccount);
  els.closeAccount().addEventListener('click', closeAccount);
  els.accountModal().addEventListener('click', (e) => { 
    if (e.target === els.accountModal()) closeAccount(); 
  });

  // Tab management
  function setTab(name) {
    const tabs = [els.tabLogin(), els.tabSignup()];
    const panels = [document.getElementById('panelLogin'), document.getElementById('panelSignup')];
    tabs.forEach(b => b && b.classList.remove('active'));
    panels.forEach(p => p && p.classList.remove('active'));
    const map = { login:'tabLogin', signup:'tabSignup' };
    const pmap = { login:'panelLogin', signup:'panelSignup' };
    const tb = els[map[name]] && els[map[name]](); 
    const pn = document.getElementById(pmap[name]);
    if (tb) tb.classList.add('active'); 
    if (pn) pn.classList.add('active');
  }

  document.addEventListener('DOMContentLoaded', () => {
    els.tabLogin() && els.tabLogin().addEventListener('click', () => setTab('login'));
    els.tabSignup() && els.tabSignup().addEventListener('click', () => setTab('signup'));
    els.myProfileBtn() && els.myProfileBtn().addEventListener('click', openProfileModal);
    els.closeProfile() && els.closeProfile().addEventListener('click', closeProfileModal);
    
    els.profileModal() && els.profileModal().addEventListener('click', (e) => {
      if (e.target === els.profileModal()) closeProfileModal();
    });

    document.querySelectorAll('.profile-nav button').forEach(btn => {
      btn.addEventListener('click', () => {
        setProfileTab(btn.dataset.tab);
      });
    });
  });

  function showAlert(msg) { 
    const box = els.alertBox(); 
    box.textContent = msg; 
    box.classList.add('show'); 
    setTimeout(()=>box.classList.remove('show'), 3500); 
  }

  // Auth tab visibility management
  function hideAuthTabs() {
    const tLogin = els.tabLogin && els.tabLogin();
    const tSignup = els.tabSignup && els.tabSignup();
    if (tLogin) tLogin.style.display = 'none';
    if (tSignup) tSignup.style.display = 'none';
    setTab('login');
  }

  function showAuthTabs() {
    const tLogin = els.tabLogin && els.tabLogin();
    const tSignup = els.tabSignup && els.tabSignup();
    if (tLogin) tLogin.style.display = '';
    if (tSignup) tSignup.style.display = '';
    setTab('login');
  }

  // User profile management
  async function upsertUserProfile(user) {
    if (!user) return;
    const ref = doc(db, 'users', user.uid);
    const snap = await getDoc(ref);
    const base = { 
      uid: user.uid, 
      email: user.email || null, 
      displayName: user.displayName || null, 
      photoURL: user.photoURL || null, 
      updatedAt: serverTimestamp() 
    };
    if (!snap.exists()) {
      await setDoc(ref, { ...base, createdAt: serverTimestamp() }); 
    } else {
      await setDoc(ref, base, { merge: true }); 
    }
  }

  function updateUserPill(user) {
    if (!user) { 
      els.userPill().style.display='none'; 
      return; 
    }
    els.userPill().style.display = '';
    const name = user.displayName || (user.email ? user.email.split('@')[0] : 'Me');
    els.userName().textContent = name;
    const ph = user.photoURL || 'https://ui-avatars.com/api/?background=0D8ABC&color=fff&name=' + encodeURIComponent(name);
    els.userAvatar().src = ph;
    els.userPill().onclick = openProfileModal;
  }

  // Authentication handlers
  els.formLogin().addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.classList.add('loading');
    try {
      const data = new FormData(els.formLogin());
      const email = data.get('email'); 
      const password = data.get('password');
      await signInWithEmailAndPassword(auth, email, password);
      await upsertUserProfile(auth.currentUser);
      closeAccount();
      showAlert('Logged in successfully');
    } catch (err) {
      console.error('Login error:', err);
      showAlert(err.message || 'Login failed');
    } finally {
      btn.classList.remove('loading');
    }
  });

  els.formSignup().addEventListener('submit', async (e) => {
    e.preventDefault();
    const btn = e.target.querySelector('button[type="submit"]');
    btn.classList.add('loading');
    try {
      const data = new FormData(els.formSignup());
      const name = (data.get('name') || '').toString().trim();
      const email = data.get('email'); 
      const password = data.get('password');
      
      const cred = await createUserWithEmailAndPassword(auth, email, password);
      
      if (name) {
        await updateProfile(cred.user, { displayName: name });
      }
      
      await upsertUserProfile({
        ...cred.user,
        displayName: name || null
      });
      
      closeAccount();
      showAlert('Account created successfully');
      els.formSignup().reset();
      
    } catch (err) {
      console.error('Signup error:', err);
      let errorMessage = 'Account creation failed';
      if (err.code === 'auth/email-already-in-use') {
        errorMessage = 'Email is already registered. Please use a different email or sign in.';
      } else if (err.code === 'auth/weak-password') {
        errorMessage = 'Password should be at least 6 characters long.';
      } else if (err.code === 'auth/invalid-email') {
        errorMessage = 'Please enter a valid email address.';
      } else if (err.code === 'auth/operation-not-allowed') {
        errorMessage = 'Email/password accounts are not enabled. Please contact support.';
      }
      showAlert(errorMessage);
    } finally {
      btn.classList.remove('loading');
    }
  });

  els.doReset().addEventListener('click', async () => {
    const email = (new FormData(els.formLogin()).get('email') || '').toString();
    if (!email) { 
      showAlert('Enter email in login form first'); 
      return; 
    }
    try { 
      await sendPasswordResetEmail(auth, email); 
      showAlert('Password reset email sent'); 
    } catch (err) { 
      showAlert(err.message); 
    }
  });

  els.formProfile().addEventListener('submit', async (e) => {
    e.preventDefault();
    const data = new FormData(els.formProfile());
    const displayName = (data.get('displayName') || '').toString() || null;
    const photoURL = (data.get('photoURL') || '').toString() || null;
    const user = auth.currentUser; 
    if (!user) { 
      showAlert('Not signed in'); 
      return; 
    }
    try {
      await updateProfile(user, { displayName, photoURL });
      await upsertUserProfile({ ...user, displayName, photoURL });
      updateUserPill({ ...user, displayName, photoURL });
      loadProfileData();
      showAlert('Profile updated');
    } catch (err) { 
      showAlert(err.message); 
    }
  });

  document.getElementById('signOutBtn')?.addEventListener('click', async () => {
    await signOut(auth); 
    showAlert('Signed out'); 
    closeProfileModal();
  });

  // Wishlist management
  function userWishlistCol() { 
    const u = auth.currentUser; 
    if (!u) return null; 
    return collection(db, 'users', u.uid, 'wishlist'); 
  }

  async function loadMyWishlist() {
    const container = document.getElementById('wishlistContainer');
    if (!auth.currentUser) {
      container.innerHTML = '<div class="muted">Sign in to see wishlist.</div>';
      return;
    }
    
    const col = userWishlistCol(); 
    if (!col) { 
      wishlist = new Set(); 
      container.innerHTML = '<div class="muted">No items in wishlist.</div>';
      return; 
    }
    const snap = await getDocs(col); 
    wishlist = new Set(snap.docs.map(d => d.id));
    
    const items = allProducts.filter(p => wishlist.has(p.id));
    if (items.length === 0) {
      container.innerHTML = '<div class="muted">No items in wishlist.</div>';
      return;
    }
    
    container.innerHTML = `
      <div class="items-grid">
        ${items.map(p => `
          <div class="item-card">
            <img src="${p.imageUrl}" alt="${p.title}" style="width:60px;height:60px;object-fit:cover;border-radius:8px;float:left;margin-right:12px;">
            <div>
              <h4 style="margin:0 0 4px;font-size:16px;">${p.title}</h4>
              <div style="color:var(--mutetext);font-size:14px;">₹${p.price}</div>
              <div style="margin-top:8px;">
                <button data-id="${p.id}" class="btn" onclick="addToCart('${p.id}')">Add to Cart</button>
                <button data-id="${p.id}" class="btn ghost" onclick="toggleWishlist('${p.id}', ${JSON.stringify(p).replace(/"/g, '&quot;')})">Remove</button>
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  async function toggleWishlist(productId, productData) {
    const col = userWishlistCol(); 
    if (!col) { 
      alert('Sign in to use wishlist'); 
      return; 
    }
    const ref = doc(db, 'users', auth.currentUser.uid, 'wishlist', productId);
    if (wishlist.has(productId)) { 
      await deleteDoc(ref); 
      wishlist.delete(productId); 
    } else {
      await setDoc(ref, { 
        id: productId, 
        title: productData.title, 
        price: Number(productData.price)||0, 
        imageUrl: productData.imageUrl || null, 
        category: productData.category || null, 
        addedAt: serverTimestamp() 
      });
      wishlist.add(productId);
    }
    renderProducts(allProducts); 
    loadMyWishlist();
  }

  window.addToCart = addToCart;
  window.toggleWishlist = toggleWishlist;

  // Orders management
  async function loadMyOrders() {
    const container = document.getElementById('ordersContainer');
    if (!auth.currentUser) { 
      container.innerHTML = '<div class="muted">Sign in to see orders.</div>'; 
      return; 
    }
    container.innerHTML = '<div class="muted">Loading orders…</div>';
    try {
      const qref = query(
        collection(db, 'orders'), 
        where('userId','==',auth.currentUser.uid), 
        orderBy('createdAt','desc')
      );
      const snap = await getDocs(qref);
      if (snap.empty) { 
        container.innerHTML = '<div class="muted">No orders yet.</div>'; 
        return; 
      }
      container.innerHTML = `
        <div class="items-grid">
          ${snap.docs.map(d => {
            const o = d.data();
            const createdAt = (o.createdAt && o.createdAt.toDate && o.createdAt.toDate()) ? 
              o.createdAt.toDate().toLocaleDateString() : '';
            return `
              <div class="item-card">
                <div>
                  <h4 style="margin:0 0 8px;font-size:16px;">Order #${d.id.slice(-8)}</h4>
                  <div style="color:var(--mutetext);font-size:14px;margin-bottom:4px;">Date: ${createdAt}</div>
                  <div style="color:var(--mutetext);font-size:14px;margin-bottom:4px;">Status: ${o.status || 'pending'}</div>
                  <div style="color:var(--mutetext);font-size:14px;margin-bottom:8px;">Total: ₹${o.total ?? o.subtotal ?? 0}</div>
                  <button class="btn ghost" onclick="navigator.clipboard && navigator.clipboard.writeText('${d.id}')">Copy ID</button>
                </div>
              </div>
            `;
          }).join('')}
        </div>
      `;
    } catch (err) { 
      console.error(err); 
      container.innerHTML = '<div class="muted">Failed to load orders. Please try again.</div>'; 
    }
  }

  // Auth state change listener
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      console.log('User signed in:', user.email);
      await upsertUserProfile(user);
      els.loginBtn().style.display = 'none';
      els.adminBtn().style.display = 'none';
      els.myProfileBtn().style.display = '';
      updateUserPill(user);
      await loadMyWishlist();
      hideAuthTabs();
    } else {
      console.log('User signed out');
      els.loginBtn().style.display = '';
      els.adminBtn().style.display = '';
      els.myProfileBtn().style.display = 'none';
      updateUserPill(null);
      wishlist = new Set();
      renderProducts(allProducts);
      showAuthTabs();
    }
  });

  // Contact form with EmailJS
  window.addEventListener('load', () => {
    const form = els.contactForm(); 
    const btn = els.sendBtn();
    form.addEventListener('submit', async (e) => {
      e.preventDefault(); 
      btn.classList.add('loading');
      try { 
        await emailjs.sendForm('service_c4p68ag', 'template_214uijp', form); 
        form.reset(); 
        alert('Message sent!'); 
      } catch (err) { 
        console.error(err); 
        alert('Failed to send.'); 
      } finally { 
        btn.classList.remove('loading'); 
      }
    });
  });

  // Cart drawer functionality
  function openCartDrawer() { 
    els.cartDrawer().style.transform = 'translateX(0)'; 
    els.cartDrawer().setAttribute('aria-hidden','false'); 
    els.cartBackdrop().style.display = 'block'; 
  }

  function closeCartDrawer() { 
    els.cartDrawer().style.transform = 'translateX(100%)'; 
    els.cartDrawer().setAttribute('aria-hidden','true'); 
    els.cartBackdrop().style.display = 'none'; 
  }

  function renderCart() {
    if (cart.length === 0) { 
      els.cartItems().innerHTML = '<div class="cart-empty">Cart is empty.</div>'; 
      els.cartSubtotal().textContent = '₹0'; 
      return; 
    }
    els.cartItems().innerHTML = cart.map(i => `
      <div class="cart-item">
        <img src="${i.imageUrl}" alt="${i.title}" />
        <div>
          <h4>${i.title}</h4>
          <div class="meta">₹${i.price} × ${i.qty} = ₹${(Number(i.price)||0)*i.qty}</div>
          <div class="qty">
            <button data-id="${i.id}" class="qty-dec">−</button>
            <span>${i.qty}</span>
            <button data-id="${i.id}" class="qty-inc">+</button>
            <button data-id="${i.id}" class="remove">Remove</button>
          </div>
        </div>
        <strong>₹${(Number(i.price)||0)*i.qty}</strong>
      </div>
    `).join('');
    els.cartSubtotal().textContent = `₹${cartSubtotalValue()}`;
    els.cartItems().querySelectorAll('.qty-inc').forEach(b => 
      b.addEventListener('click', () => incQty(b.dataset.id)));
    els.cartItems().querySelectorAll('.qty-dec').forEach(b => 
      b.addEventListener('click', () => decQty(b.dataset.id)));
    els.cartItems().querySelectorAll('.remove').forEach(b => 
      b.addEventListener('click', () => removeItem(b.dataset.id)));
  }

  document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('openCart').addEventListener('click', openCartDrawer);
    document.getElementById('closeCart').addEventListener('click', closeCartDrawer);
    document.getElementById('cartBackdrop').addEventListener('click', closeCartDrawer);
    document.getElementById('clearCart').addEventListener('click', clearCart);
    document.getElementById('checkoutBtn').addEventListener('click', openCheckout);
  });

  // Admin functionality
  const ADMIN_SESSION_KEY = 'isAdmin';
  
  function isAdmin() { 
    return localStorage.getItem(ADMIN_SESSION_KEY) === 'true'; 
  }
  
  function setAdmin(v) { 
    localStorage.setItem(ADMIN_SESSION_KEY, v ? 'true' : 'false'); 
    syncAdminUI(); 
  }
  
  function openAdmin() { 
    els.adminBackdrop().style.display = 'flex'; 
    els.adminBackdrop().setAttribute('aria-hidden','false'); 
    syncAdminUI(); 
  }
  
  function closeAdminModal() { 
    els.adminBackdrop().style.display = 'none'; 
    els.adminBackdrop().setAttribute('aria-hidden','true'); 
  }

  document.getElementById('adminBtn').addEventListener('click', openAdmin);
  document.getElementById('closeAdmin').addEventListener('click', closeAdminModal);
  document.getElementById('adminBackdrop').addEventListener('click', (e) => { 
    if (e.target === els.adminBackdrop()) closeAdminModal(); 
  });

  function syncAdminUI() {
    const unlocked = isAdmin();
    els.adminState().textContent = unlocked ? 'Unlocked' : 'Locked';
    els.adminState().style.color = unlocked ? '#0a7' : '#92400e';
    els.productCard().style.display = unlocked ? '' : 'none';
    els.categoryCard().style.display = unlocked ? '' : 'none';
  }

  els.unlockAdmin().addEventListener('click', () => {
    const code = (els.adminCode().value || '').trim();
    if (code === '741223') { 
      setAdmin(true); 
      alert('Admin unlocked'); 
    } else { 
      alert('Invalid code'); 
    }
  });

  // Image upload functionality
  async function uploadImagePublic(file, pathPrefix = 'public_uploads', onProgress) {
    if (!file) throw new Error('No file selected');
    const safeName = (file.name || 'image').replace(/\s+/g, '_').replace(/[^A-Za-z0-9._-]/g, '');
    const ts = Date.now();
    const rand = Math.random().toString(36).slice(2, 8);
    const path = `${pathPrefix}/${ts}_${rand}_${safeName}`;
    const ref = sRef(storage, path);
    const metadata = { contentType: file.type || 'image/jpeg' };
    const task = uploadBytesResumable(ref, file, metadata);
    return await new Promise((resolve, reject) => {
      task.on('state_changed', (snap) => {
        const pct = Math.round((snap.bytesTransferred / snap.totalBytes) * 100);
        onProgress && onProgress(pct);
      }, reject, async () => {
        const url = await getDownloadURL(task.snapshot.ref);
        resolve(url);
      });
    });
  }

  // Upload event handlers
  document.addEventListener('DOMContentLoaded', () => {
    const upProd = els.uploadProdImg && els.uploadProdImg();
    if (upProd) upProd.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const file = els.prodImageFile().files[0];
        const prog = els.prodUploadProg(); 
        const preview = els.prodPreview();
        prog.style.display = 'block';
        const url = await uploadImagePublic(file, 'public_uploads/products', (pct) => { 
          prog.value = pct; 
        });
        els.prodImageUrl().value = url;
        preview.src = url; 
        preview.style.display = 'block';
        alert('Product image uploaded');
      } catch (err) { 
        console.error(err); 
        alert(err.message || 'Upload failed'); 
      } finally { 
        const prog = els.prodUploadProg(); 
        setTimeout(()=>{ prog.style.display='none'; prog.value=0; }, 600); 
      }
    });

    const upCat = els.uploadCatImg && els.uploadCatImg();
    if (upCat) upCat.addEventListener('click', async (e) => {
      e.preventDefault();
      try {
        const file = els.catImageFile().files[0];
        const prog = els.catUploadProg(); 
        const preview = els.catPreview();
        prog.style.display = 'block';
        const url = await uploadImagePublic(file, 'public_uploads/categories', (pct) => { 
          prog.value = pct; 
        });
        els.catImageUrl().value = url;
        preview.src = url; 
        preview.style.display = 'block';
        alert('Category image uploaded');
      } catch (err) { 
        console.error(err); 
        alert(err.message || 'Upload failed'); 
      } finally { 
        const prog = els.catUploadProg(); 
        setTimeout(()=>{ prog.style.display='none'; prog.value=0; }, 600); 
      }
    });
  });

  // Admin form handlers
  document.getElementById('formAddProduct').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!isAdmin()) { 
      alert('Admin locked'); 
      return; 
    }
    const fd = new FormData(e.currentTarget);
    const imageUrl = (fd.get('imageUrl') || '').toString();
    if (!imageUrl) { 
      alert('Please upload an image first'); 
      return; 
    }
    const data = {
      title: (fd.get('title') || '').toString(),
      price: Number(fd.get('price') || 0),
      imageUrl,
      category: (fd.get('category') || '').toString(),
      stock: parseInt(fd.get('stock') || '0', 10),
      createdAt: Date.now(),
    };
    try {
      await addDoc(collection(db, 'products'), data);
      alert('Product added');
      e.currentTarget.reset();
      if (els.prodPreview()) { 
        els.prodPreview().style.display='none'; 
        els.prodPreview().src=''; 
      }
      if (els.prodImageUrl()) els.prodImageUrl().value='';
      loadHome();
    } catch (err) { 
      console.error(err); 
      alert('Failed to add product'); 
    }
  });

  document.getElementById('formAddCategory').addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!isAdmin()) { 
      alert('Admin locked'); 
      return; 
    }
    const fd = new FormData(e.currentTarget);
    const imageUrl = (fd.get('imageUrl') || '').toString();
    if (!imageUrl) { 
      alert('Please upload an image first'); 
      return; 
    }
    const data = {
      name: (fd.get('name') || '').toString(),
      slug: (fd.get('slug') || '').toString(),
      imageUrl,
      createdAt: Date.now(),
    };
    try {
      await addDoc(collection(db, 'categories'), data);
      alert('Category added');
      e.currentTarget.reset();
      if (els.catPreview()) { 
        els.catPreview().style.display='none'; 
        els.catPreview().src=''; 
      }
      if (els.catImageUrl()) els.catImageUrl().value='';
      loadHome();
    } catch (err) { 
      console.error(err); 
      alert('Failed to add category'); 
    }
  });

  // UPI payment functionality
  function drawQRToCanvas(canvas, text) {
    const url = 'https://chart.googleapis.com/chart?cht=qr&chs=200x200&chl=' + encodeURIComponent(text);
    const img = new Image(); 
    img.crossOrigin = 'anonymous';
    img.onload = () => {
      const ctx = canvas.getContext('2d'); 
      const size = Math.min(canvas.width, canvas.height);
      ctx.clearRect(0,0,canvas.width,canvas.height); 
      ctx.drawImage(img, 0, 0, size, size);
    };
    img.src = url;
  }

  function buildUpiLink({ vpa, name, amount, note, txnRef }) {
    const params = new URLSearchParams({ 
      pa: vpa, 
      pn: name, 
      am: String(amount||0), 
      cu: 'INR', 
      tn: note||'', 
      tr: txnRef||'' 
    });
    return `upi://pay?${params.toString()}`;
  }

  function initCheckoutPaymentUI(totalAmount) {
    const radios = document.querySelectorAll('input[name="payment"]');
    const upiBox = els.upiBox(); 
    const upiPayee = els.upiPayee(); 
    const upiAmount = els.upiAmount(); 
    const upiNoteEl = els.upiNote();
    const upiBtn = els.upiPayBtn(); 
    const upiQR = els.upiQR();
    const orderRef = 'ORD-' + Date.now(); 
    const note = `${UPI_NOTE_PREFIX} ${orderRef}`;
    upiPayee.textContent = UPI_VPA; 
    upiAmount.textContent = `₹${totalAmount}`; 
    upiNoteEl.textContent = note;
    
    function refreshUPI() {
      const upiLink = buildUpiLink({ 
        vpa: UPI_VPA, 
        name: UPI_NAME, 
        amount: totalAmount, 
        note, 
        txnRef: orderRef 
      });
      upiBtn.onclick = () => { window.location.href = upiLink; };
      drawQRToCanvas(upiQR, upiLink);
    }
    
    function onChange() {
      const val = document.querySelector('input[name="payment"]:checked')?.value;
      upiBox.style.display = (val === 'upi') ? 'block' : 'none';
      if (val === 'upi') refreshUPI();
    }
    
    radios.forEach(r => r.addEventListener('change', onChange));
    onChange();
    initCheckoutPaymentUI._orderRef = orderRef; 
    initCheckoutPaymentUI._note = note;
  }

  // Checkout functionality
  function openCheckout() {
    if (!auth.currentUser) { 
      alert('Sign in to continue to checkout.'); 
      return; 
    }
    if (!cart || cart.length === 0) { 
      alert('Cart is empty.'); 
      return; 
    }
    els.checkoutForm().querySelector('[name="email"]').value = auth.currentUser.email || '';
    const subtotal = cartSubtotalValue();
    els.ckItemsCount().textContent = cart.reduce((s,i)=>s+(i.qty||0),0);
    els.ckSubtotal().textContent = `₹${subtotal}`;
    els.ckTotal().textContent = `₹${subtotal}`;
    els.ckItemsList().innerHTML = cart.map(i => 
      `${i.title} — ₹${i.price} × ${i.qty}`).join('<br/>');
    initCheckoutPaymentUI(subtotal);
    els.checkoutBackdrop().style.display = 'flex'; 
    els.checkoutBackdrop().setAttribute('aria-hidden','false');
  }

  function closeCheckoutModal() { 
    els.checkoutBackdrop().style.display = 'none'; 
    els.checkoutBackdrop().setAttribute('aria-hidden','true'); 
  }

  els.closeCheckout().addEventListener('click', closeCheckoutModal);
  els.checkoutBackdrop().addEventListener('click', (e) => { 
    if (e.target === els.checkoutBackdrop()) closeCheckoutModal(); 
  });

  // Order placement with simple notification
  els.checkoutForm().addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!auth.currentUser) { 
      alert('Not signed in.'); 
      return; 
    }
    if (!cart || cart.length === 0) { 
      alert('Cart is empty.'); 
      return; 
    }

    const fd = new FormData(els.checkoutForm());
    const method = (document.querySelector('input[name="payment"]:checked')?.value) || 'cod';
    const total = cartSubtotalValue();

    let upi = null;
    if (method === 'upi') {
      const txnRef = initCheckoutPaymentUI._orderRef || ('ORD-' + Date.now());
      const note = initCheckoutPaymentUI._note || `${UPI_NOTE_PREFIX} ${txnRef}`;
      const upiLink = buildUpiLink({ 
        vpa: UPI_VPA, 
        name: UPI_NAME, 
        amount: total, 
        note, 
        txnRef 
      });
      upi = { vpa: UPI_VPA, name: UPI_NAME, link: upiLink, txnRef, note };
    }

    const payload = {
      userId: auth.currentUser.uid,
      email: (fd.get('email') || '').toString(),
      fullName: (fd.get('fullName') || '').toString(),
      phone: (fd.get('phone') || '').toString(),
      address: (fd.get('address') || '').toString(),
      paymentMethod: method,
      upi,
      currency: 'INR',
      items: cart.map(i => ({ 
        id: i.id, 
        title: i.title, 
        price: Number(i.price)||0, 
        qty: i.qty||0, 
        imageUrl: i.imageUrl 
      })),
      subtotal: total,
      shipping: 0,
      total: total,
      status: 'pending',
      createdAt: serverTimestamp(),
      updatedAt: serverTimestamp(),
    };

    els.placeOrderBtn().classList.add('loading');

    try {
      const ref = await addDoc(collection(db, 'orders'), payload);
      const orderId = ref.id;
      
      try {
        const itemsText = payload.items.map(i => 
          `${i.title} x${i.qty} = ₹${i.price * i.qty}`).join('\n');
        await emailjs.send('service_c4p68ag', 'template_214uijp', { 
          name: payload.fullName, 
          email: payload.email, 
          order_id: orderId, 
          items_text: itemsText, 
          total: `₹${payload.total}` 
        });
      } catch (emailErr) { 
        console.warn('Email send failed (continuing):', emailErr); 
      }
      
      cart = []; 
      localStorage.setItem('cart', JSON.stringify(cart)); 
      updateCartBadge(); 
      renderCart(); 
      closeCheckoutModal(); 
      
      showOrderPlacedNotification(orderId);
      loadMyOrders();
      
    } catch (err) { 
      console.error(err); 
      alert('Failed to place order. Please try again.'); 
    } finally { 
      els.placeOrderBtn().classList.remove('loading'); 
    }
  });

  // Initialize app
  updateCartBadge(); 
  renderCart(); 
  loadHome();
</script>

<!-- EmailJS SDK + init -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@4/dist/email.min.js" defer></script>
<script defer>
  window.addEventListener('load', () => { emailjs.init('E8cAV9p-pSYDnM8kE'); });
</script>
<!-- Canvas Confetti CDN for simple confetti -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js" defer></script>
</head>
<body>
  <header class="header">
    <div class="logo">Crodyto</div>
    <div class="search"><input id="search" placeholder="Search products..." /></div>
    <nav>
      <button id="loginBtn" class="btn">Login</button>
      <button id="myProfileBtn" class="btn" style="display:none">My Profile</button>
      <button id="adminBtn" class="btn">Admin</button>
      <button id="openCart" class="btn cart-toggle">Cart <span id="cartCount" class="badge">0</span></button>
      <label style="display:flex;align-items:center;gap:6px;margin-left:8px">
        <input id="themeToggle" type="checkbox" />
        <span>Dark</span>
      </label>
      <div id="userPill" class="btn" style="display:none;gap:8px;align-items:center">
        <img id="userAvatar" alt="avatar" style="width:22px;height:22px;border-radius:50%;object-fit:cover" />
        <span id="userName"></span>
      </div>
    </nav>
  </header>

  <section class="hero">
    <h1>Big Savings, Daily</h1>
    <p class="muted">Discover deals across fashion, electronics, and more.</p>
  </section>

  <section>
    <h2 style="padding:0 16px;margin:16px 0 0">Categories</h2>
    <div id="categoryGrid" class="grid"></div>
  </section>

  <section>
    <h2 style="padding:0 16px;margin:16px 0 0">Featured</h2>
    <div id="productGrid" class="grid"></div>
  </section>

  <section class="contact">
    <h2>Contact</h2>
    <form id="contactForm">
      <input name="from_name" placeholder="Name" required />
      <input name="reply_to" type="email" placeholder="Email" required />
      <textarea name="message" placeholder="Message" required></textarea>
      <button id="sendBtn" class="btn primary" type="submit">
        <span class="txt">Send</span>
        <span class="spinner" aria-hidden="true"></span>
      </button>
    </form>
  </section>

  <!-- Login Modal -->
  <div id="accountModal" class="modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="modal">
      <header>
        <h3>Account</h3>
        <button class="close" aria-label="Close" id="closeAccount">×</button>
      </header>

      <div class="tabs">
        <button id="tabLogin" class="active">Log in</button>
        <button id="tabSignup">Sign up</button>
      </div>

      <div id="alertBox" class="alert"></div>

      <section id="panelLogin" class="panel active">
        <form id="formLogin" class="row">
          <input name="email" type="email" placeholder="Email" required />
          <input name="password" type="password" placeholder="Password" required />
          <button class="btn primary" type="submit">
            <span class="txt">Log in</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
        </form>
        <button id="doReset" class="btn" type="button">Forgot password?</button>
      </section>

      <section id="panelSignup" class="panel">
        <form id="formSignup" class="row">
          <input name="name" placeholder="Full name" />
          <input name="email" type="email" placeholder="Email" required />
          <input name="password" type="password" placeholder="Password (6+ characters)" required />
          <button class="btn primary" type="submit">
            <span class="txt">Create account</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
        </form>
        <p class="muted">By creating an account, you agree to our terms of service.</p>
      </section>
    </div>
  </div>

  <!-- Enhanced Profile Modal with Ambient Effects -->
  <div id="profileModal" class="profile-modal-backdrop" role="dialog" aria-modal="true" aria-hidden="true">
    <div class="profile-modal">
      <div class="profile-modal-header">
        <h3>My Profile</h3>
        <button class="close" aria-label="Close" id="closeProfile">×</button>
      </div>
      
      <div class="profile-content">
        <!-- Profile Header with Ambient Orbs -->
        <div class="profile-header">
          <div class="ambient-orbs">
            <div class="orb"></div>
            <div class="orb"></div>
            <div class="orb"></div>
          </div>
          <div class="profile-avatar-section">
            <img id="profileAvatar" class="profile-avatar" alt="Profile" />
            <div class="profile-info">
              <h2 id="profileDisplayName">User</h2>
              <p id="profileEmail">user@example.com</p>
            </div>
          </div>
        </div>

        <!-- Profile Navigation -->
        <div class="profile-nav">
          <button data-tab="settings" class="active">Settings</button>
          <button data-tab="orders">Orders</button>
          <button data-tab="wishlist">Wishlist</button>
        </div>

        <!-- Profile Content Panels -->
        <div class="profile-panels">
          <!-- Settings Panel -->
          <div id="settingsPanel" class="profile-panel active">
            <h3 style="margin-bottom:20px;">Profile Settings</h3>
            <form id="formProfile" class="profile-form">
              <div class="form-group">
                <label>Display Name</label>
                <input id="displayNameInput" name="displayName" placeholder="Your display name" />
              </div>
              <div class="form-group">
                <label>Photo URL</label>
                <input id="photoURLInput" name="photoURL" type="url" placeholder="https://example.com/photo.jpg" />
              </div>
              <button class="btn primary" type="submit">Save Changes</button>
            </form>
            <div style="margin-top:24px;padding-top:24px;border-top:1px solid var(--border);">
              <button id="signOutBtn" class="btn ghost">Sign Out</button>
            </div>
          </div>

          <!-- Orders Panel -->
          <div id="ordersPanel" class="profile-panel">
            <h3 style="margin-bottom:20px;">My Orders</h3>
            <div id="ordersContainer">
              <div class="muted">Loading orders...</div>
            </div>
          </div>

          <!-- Wishlist Panel -->
          <div id="wishlistPanel" class="profile-panel">
            <h3 style="margin-bottom:20px;">My Wishlist</h3>
            <div id="wishlistContainer">
              <div class="muted">Loading wishlist...</div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Cart Drawer -->
  <div id="cartDrawer" class="cart-drawer" aria-hidden="true">
    <div class="cart-header">
      <strong>Cart</strong>
      <button id="closeCart" class="btn">Close</button>
    </div>
    <div id="cartItems" class="cart-items"></div>
    <div class="cart-footer">
      <div class="cart-row">
        <span>Subtotal</span>
        <strong id="cartSubtotal">₹0</strong>
      </div>
      <div class="cart-actions">
        <button id="clearCart" class="btn">Clear</button>
        <button id="checkoutBtn" class="btn primary" style="flex:1">Checkout</button>
      </div>
    </div>
  </div>
  <div id="cartBackdrop" class="cart-drawer-backdrop"></div>

  <!-- Admin Modal -->
  <div id="adminBackdrop" class="admin-backdrop" aria-hidden="true">
    <div class="admin-modal">
      <header>
        <h3>Admin</h3>
        <button id="closeAdmin" class="close" aria-label="Close">×</button>
      </header>
      <div class="admin-body">
        <div class="admin-card" id="adminGateCard">
          <h4>Unlock Admin</h4>
          <div class="admin-gate">
            <input id="adminCode" placeholder="Enter admin code" />
            <button id="unlockAdmin" class="btn primary">Unlock</button>
            <span id="adminState" class="admin-badge">Locked</span>
          </div>
          <p class="muted">Client-side gate only; use Firestore Rules + custom claims to secure writes in production.</p>
        </div>

        <div class="admin-card" id="productCard" style="display:none">
          <h4>Add Product</h4>
          <form id="formAddProduct" class="row">
            <input name="title" placeholder="Title" required />
            <input name="price" type="number" step="0.01" placeholder="Price" required />
            <div class="row">
              <input id="prodImageFile" type="file" accept="image/*" />
              <div style="display:flex;gap:8px;align-items:center">
                <button id="uploadProdImg" class="btn">Upload image</button>
                <progress id="prodUploadProg" value="0" max="100" style="width:160px; height:8px; display:none"></progress>
              </div>
              <img id="prodPreview" alt="preview" style="width:100%;max-height:160px;object-fit:cover;border-radius:8px;display:none" />
              <input name="imageUrl" id="prodImageUrl" type="hidden" />
            </div>
            <input name="category" placeholder="Category slug (e.g., fashion)" required />
            <input name="stock" type="number" step="1" placeholder="Stock (e.g., 20)" required />
            <button class="btn primary" type="submit">Add product</button>
          </form>
        </div>

        <div class="admin-card" id="categoryCard" style="display:none">
          <h4>Add Category</h4>
          <form id="formAddCategory" class="row">
            <input name="name" placeholder="Name (e.g., Fashion)" required />
            <input name="slug" placeholder="Slug (e.g., fashion)" required />
            <div class="row">
              <input id="catImageFile" type="file" accept="image/*" />
              <div style="display:flex;gap:8px;align-items:center">
                <button id="uploadCatImg" class="btn">Upload image</button>
                <progress id="catUploadProg" value="0" max="100" style="width:160px; height:8px; display:none"></progress>
              </div>
              <img id="catPreview" alt="preview" style="width:100%;max-height:160px;object-fit:cover;border-radius:8px;display:none" />
              <input name="imageUrl" id="catImageUrl" type="hidden" />
            </div>
            <button class="btn primary" type="submit">Add category</button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Checkout Modal -->
  <div id="checkoutBackdrop" class="checkout-backdrop" aria-hidden="true">
    <div class="checkout-modal">
      <header>
        <h3>Checkout</h3>
        <button id="closeCheckout" class="close" aria-label="Close">×</button>
      </header>
      <div class="checkout-body">
        <form id="checkoutForm" class="ck-row">
          <input name="fullName" placeholder="Full name" required />
          <input name="email" type="email" placeholder="Email for updates" required />
          <input name="phone" type="tel" placeholder="Phone" required />
          <textarea name="address" placeholder="Shipping address" rows="4" required></textarea>

          <div class="ck-row" id="payMethods">
            <label><input type="radio" name="payment" value="cod" checked /> Cash on Delivery</label>
            <label><input type="radio" name="payment" value="upi" /> UPI</label>
          </div>

          <div id="upiBox" class="summary" style="display:none; margin-top:8px">
            <h4>UPI payment</h4>
            <div class="line"><span>Payee</span><strong id="upiPayee">example@upi</strong></div>
            <div class="line"><span>Amount</span><strong id="upiAmount">₹0</strong></div>
            <div class="line"><span>Note</span><strong id="upiNote">Crodyto order</strong></div>
            <div style="display:flex; gap:12px; align-items:center; margin-top:8px; flex-wrap:wrap">
              <button id="upiPayBtn" class="btn" type="button">Pay with UPI</button>
              <canvas id="upiQR" width="132" height="132" style="border:1px solid var(--border); border-radius:8px"></canvas>
            </div>
            <p class="muted">On mobile, tap "Pay with UPI" to open an installed UPI app with details pre-filled. On desktop, scan the QR using any UPI app. After paying, return here and place the order.</p>
          </div>

          <button id="placeOrderBtn" class="btn primary" type="submit">
            <span class="txt">Place order</span>
            <span class="spinner" aria-hidden="true"></span>
          </button>
        </form>

        <div class="summary">
          <h4>Order summary</h4>
          <div class="line"><span>Items</span><strong id="ckItemsCount">0</strong></div>
          <div class="line"><span>Subtotal</span><strong id="ckSubtotal">₹0</strong></div>
          <div class="line"><span>Shipping</span><strong>₹0</strong></div>
          <div class="line"><span>Total</span><strong id="ckTotal">₹0</strong></div>
          <div id="ckItemsList" class="items"></div>
        </div>
      </div>
    </div>
  </div>

  <footer>WELCOME TO CRODYTO</footer>
</body>
</html>
